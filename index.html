import React, { useMemo, useState, useEffect } from "react";
import { CheckCircle2, HelpCircle, Layers, PlayCircle, RotateCcw, TimerReset, XCircle, BookOpen, Brain, Clock, Landmark, Library, ListChecks, Sparkles, ShieldCheck } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Progress } from "@/components/ui/progress";

// ------------------ DATA ------------------
const tijdvakken = [
  { nr: 1, naam: "Jagers en boeren", jaren: "tot 3000 v.Chr.", kern: "Landbouw, dorpen, eerste steden" },
  { nr: 2, naam: "Grieken en Romeinen", jaren: "3000 v.Chr. – 500 n.Chr.", kern: "Democratie, wetenschap, Romeins rijk" },
  { nr: 3, naam: "Monniken en ridders", jaren: "500 – 1000", kern: "Christendom, leenstelsel, hofstelsel" },
  { nr: 4, naam: "Steden en staten", jaren: "1000 – 1500", kern: "Handel, steden, macht van koningen en kerk" },
  { nr: 5, naam: "Ontdekkers en hervormers", jaren: "1500 – 1600", kern: "Renaissance, ontdekkingsreizen, Reformatie" },
  { nr: 6, naam: "Regenten en vorsten", jaren: "1600 – 1700", kern: "Absolutisme, Gouden Eeuw" },
  { nr: 7, naam: "Pruiken en revoluties", jaren: "1700 – 1800", kern: "Verlichting, revoluties" },
  { nr: 8, naam: "Burgers en stoommachines", jaren: "1800 – 1900", kern: "Industrialisatie" },
  { nr: 9, naam: "Wereldoorlogen", jaren: "1900 – 1950", kern: "Eerste en Tweede Wereldoorlog, Holocaust" },
  { nr: 10, naam: "Televisie en computer", jaren: "1950 – nu", kern: "Informatietijdperk, globalisering" },
];

const flashcardsT1 = [
  { q: "Nomadisch", a: "Rondtrekkend leven; geen vaste woonplaats." },
  { q: "Sedentair", a: "Vaste woonplaats; op één plek wonen (na de landbouw)." },
  { q: "Landbouwrevolutie", a: "Overgang van jagen/verzamelen naar landbouw en veeteelt (ca. 10.000 v.Chr.)." },
  { q: "Sociale gelaagdheid", a: "Verschil in macht en rijkdom tussen groepen in de samenleving." },
  { q: "Einde prehistorie", a: "Rond 3000 v.Chr. door de uitvinding van het schrift." },
];

const flashcardsT2 = [
  { q: "Polis", a: "Griekse stadstaat met eigen bestuur, leger en wetten." },
  { q: "Democratie (Athene)", a: "Burgers (vrije mannen met Atheense ouders) beslissen in de volksvergadering." },
  { q: "Filosofie / wetenschappelijk denken", a: "Met rede en logica verklaringen zoeken (Socrates, Plato, Aristoteles)." },
  { q: "Romanisering", a: "Verspreiding van Romeinse taal/cultuur/recht door veroveringen en contact." },
  { q: "Pax Romana", a: "Lange periode van vrede en welvaart in het Romeinse rijk." },
  { q: "Polytheïsme ↔ Monotheïsme", a: "Veel goden (Grieken/Romeinen) ↔ één God (jodendom/christendom)." },
  { q: "Byzantijnse Rijk", a: "Oost-Romeinse rijk met hoofdstad Constantinopel." },
];

const quiz = {
  t1: [
    { t: "Wat was de landbouwrevolutie?", type: "open", check: (x) => /landbouw|overgang|veeteelt/i.test(x) },
    { t: "Wat betekent 'sedentair'?", type: "open", check: (x) => /vaste|één plek|niet rondtrekken/i.test(x) },
    { t: "Wat markeert het einde van de prehistorie?", type: "mc", options: ["Ontstaan van landbouw", "Uitvinding van het schrift", "Ontstaan van steden", "Ontdekking van vuur"], answer: 1 },
    { t: "Noem één gevolg van landbouw.", type: "open", check: (x) => /dorpen|steden|overschot|specialisatie|bevolking|handel|schrift/i.test(x) },
  ],
  t2: [
    { t: "Wie zijn bekende Griekse filosofen?", type: "mc", options: ["Herodotus, Caesar, Augustus", "Socrates, Plato, Aristoteles", "Pericles, Spartacus, Jezus", "Leonardo, Michelangelo, Raphael"], answer: 1 },
    { t: "Wat betekent romanisering?", type: "open", check: (x) => /Romeins|taal|cultuur|recht|verspreiding/i.test(x) },
    { t: "Wat was de Pax Romana?", type: "mc", options: ["Religieus feest", "Periode van vrede en welvaart", "Burgeroorlog", "Val van het rijk"], answer: 1 },
    { t: "Waarom zagen Romeinen het christendom eerst als bedreiging?", type: "open", check: (x) => /weigerden|keizer|vereren|één god|monotheïsme/i.test(x) },
  ],
  tijdlijn: [
    { t: "In welk tijdvak hoort 'democratie in Athene' thuis?", type: "mc", options: ["Tijdvak 1", "Tijdvak 2", "Tijdvak 3", "Tijdvak 4"], answer: 1 },
    { t: "Wanneer eindigt de prehistorie?", type: "mc", options: ["3000 v.Chr.", "500 n.Chr.", "1500 n.Chr.", "1950"], answer: 0 },
  ],
};

// ------------------ UI HELPERS ------------------
function Pill({ children }: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-2xl px-3 py-1 text-xs font-medium border shadow-sm">
      {children}
    </span>
  );
}

function Section({ title, icon, children, subtitle }: any) {
  return (
    <Card className="w-full max-w-5xl mx-auto rounded-2xl shadow-lg">
      <CardContent className="p-6 md:p-8">
        <div className="flex items-center gap-3 mb-3">
          {icon}
          <h2 className="text-xl md:text-2xl font-semibold">{title}</h2>
        </div>
        {subtitle && <p className="text-sm opacity-80 mb-4">{subtitle}</p>}
        <div>{children}</div>
      </CardContent>
    </Card>
  );
}

// ------------------ COMPONENT ------------------
export default function App() {
  const [tab, setTab] = useState<'plan' | 't1' | 't2' | 'tijdlijn' | 'quiz'>('plan');
  const [timerOn, setTimerOn] = useState(false);
  const [seconds, setSeconds] = useState(60 * 60); // 1 uur

  useEffect(() => {
    if (!timerOn) return;
    const id = setInterval(() => setSeconds((s) => (s > 0 ? s - 1 : 0)), 1000);
    return () => clearInterval(id);
  }, [timerOn]);

  const pct = useMemo(() => 100 - (seconds / 3600) * 100, [seconds]);
  const mm = String(Math.floor(seconds / 60)).padStart(2, '0');
  const ss = String(seconds % 60).padStart(2, '0');

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-white to-slate-50 p-4 md:p-8">
      <header className="max-w-5xl mx-auto flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
        <div className="space-y-1">
          <h1 className="text-2xl md:text-4xl font-extrabold tracking-tight flex items-center gap-2">
            <Sparkles className="w-6 h-6"/> Geschiedenis Toetstrainer — Tijdvak 1 & 2
          </h1>
          <p className="opacity-80 text-sm md:text-base">In 1 uur de kern van <b>Jagers & Boeren</b> en <b>Grieken & Romeinen</b> leren. Met flashcards, quiz en tijdlijn.</p>
          <div className="flex flex-wrap gap-2 mt-2">
            <Pill><Clock className="w-3 h-3 mr-1"/> 1-uurs plan</Pill>
            <Pill><Brain className="w-3 h-3 mr-1"/> Actief herinneren</Pill>
            <Pill><Library className="w-3 h-3 mr-1"/> Kenmerkende aspecten</Pill>
          </div>
        </div>
        <div className="w-full md:w-64">
          <div className="flex items-center gap-2 mb-2">
            <TimerReset className="w-5 h-5"/>
            <span className="font-mono text-lg">{mm}:{ss}</span>
          </div>
          <Progress value={pct} />
          <div className="flex gap-2 mt-2">
            <Button onClick={() => setTimerOn(true)} className="grow"><PlayCircle className="w-4 h-4 mr-1"/>Start</Button>
            <Button variant="secondary" onClick={() => {setTimerOn(false); setSeconds(3600);}}><RotateCcw className="w-4 h-4 mr-1"/>Reset</Button>
          </div>
        </div>
      </header>

      {/* Tabs */}
      <nav className="max-w-5xl mx-auto grid grid-cols-2 md:grid-cols-5 gap-2 mb-6">
        <Button variant={tab==='plan' ? 'default':'secondary'} onClick={()=>setTab('plan')}><ListChecks className="w-4 h-4 mr-1"/>Plan</Button>
        <Button variant={tab==='t1' ? 'default':'secondary'} onClick={()=>setTab('t1')}><BookOpen className="w-4 h-4 mr-1"/>Tijdvak 1</Button>
        <Button variant={tab==='t2' ? 'default':'secondary'} onClick={()=>setTab('t2')}><Landmark className="w-4 h-4 mr-1"/>Tijdvak 2</Button>
        <Button variant={tab==='tijdlijn' ? 'default':'secondary'} onClick={()=>setTab('tijdlijn')}><Layers className="w-4 h-4 mr-1"/>Tijdvakken</Button>
        <Button variant={tab==='quiz' ? 'default':'secondary'} onClick={()=>setTab('quiz')}><HelpCircle className="w-4 h-4 mr-1"/>Quiz</Button>
      </nav>

      {tab === 'plan' && <StudyPlan />}
      {tab === 't1' && <VakT1 />}
      {tab === 't2' && <VakT2 />}
      {tab === 'tijdlijn' && <Tijdlijn />}
      {tab === 'quiz' && <Quiz />}

      <footer className="max-w-5xl mx-auto mt-10 text-xs opacity-70 text-center">
        Gemaakt voor snel leren. Tip: werk hardop, schrijf kernwoorden, en herhaal fouten.
      </footer>
    </div>
  );
}

// -------------- SUBCOMPONENTS --------------
function StudyPlan() {
  return (
    <Section title="1-uurs studieplan" icon={<ListChecks className="w-6 h-6"/>} subtitle="Volg de stappen en wissel na elk blok van tab.">
      <ol className="grid md:grid-cols-2 gap-4 list-decimal pl-6">
        <li className="bg-white rounded-2xl p-4 shadow-sm">
          <h3 className="font-semibold mb-1">0–10 min · Overzicht maken</h3>
          <p className="text-sm opacity-80">Bekijk de tab <b>Tijdvakken</b> en lees de rijtjes hardop. Snap waar tijdvak 1 & 2 in het geheel passen.</p>
        </li>
        <li className="bg-white rounded-2xl p-4 shadow-sm">
          <h3 className="font-semibold mb-1">10–30 min · Tijdvak 1</h3>
          <p className="text-sm opacity-80">Leer de flashcards en voorbeelden. Begrijp oorzaak → gevolg: landbouw → overschot → specialisatie → steden → schrift.</p>
        </li>
        <li className="bg-white rounded-2xl p-4 shadow-sm">
          <h3 className="font-semibold mb-1">30–50 min · Tijdvak 2</h3>
          <p className="text-sm opacity-80">Lees Grieken (democratie/filosofie) en Romeinen (imperium/romanisering/Pax Romana). Check kunst & religie.</p>
        </li>
        <li className="bg-white rounded-2xl p-4 shadow-sm">
          <h3 className="font-semibold mb-1">50–60 min · Quiz</h3>
          <p className="text-sm opacity-80">Maak de quiz-tab; herhaal de vragen die je fout hebt. Eindig met 5 flashcards die je het lastigst vond.</p>
        </li>
      </ol>
    </Section>
  );
}

function Flashcards({ items }: { items: { q: string; a: string }[] }) {
  const [i, setI] = useState(0);
  const [show, setShow] = useState(false);
  const progress = ((i) / items.length) * 100;

  return (
    <div className="bg-white rounded-2xl p-6 shadow-sm">
      <div className="flex items-center justify-between mb-4">
        <div className="font-semibold">Flashcard {i + 1} / {items.length}</div>
        <div className="w-40"><Progress value={progress} /></div>
      </div>
      <div className="p-6 rounded-xl border text-center text-lg md:text-2xl font-semibold">
        {items[i].q}
      </div>
      {show && (
        <div className="mt-3 p-4 rounded-xl border bg-slate-50 text-sm">{items[i].a}</div>
      )}
      <div className="flex gap-2 mt-4">
        <Button variant="secondary" onClick={() => setShow((s) => !s)}>{show ? 'Verberg antwoord' : 'Toon antwoord'}</Button>
        <Button onClick={() => { setShow(false); setI((x) => Math.min(x + 1, items.length - 1)); }}>Volgende</Button>
        <Button variant="secondary" onClick={() => { setShow(false); setI((x) => Math.max(x - 1, 0)); }}>Terug</Button>
      </div>
    </div>
  );
}

function Bullet({ children }: any) {
  return <li className="flex gap-2"><span className="mt-1">•</span><span>{children}</span></li>;
}

function VakT1() {
  return (
    <Section title="Tijdvak 1 – Jagers en boeren" icon={<BookOpen className="w-6 h-6"/>} subtitle="Wat je moet weten + flashcards">
      <div className="grid lg:grid-cols-2 gap-6">
        <div className="space-y-4">
          <div className="bg-white rounded-2xl p-5 shadow-sm">
            <h3 className="font-semibold mb-2">Kern</h3>
            <ul className="text-sm leading-6">
              <Bullet>Jagers-verzamelaars leefden <b>nomadisch</b> in kleine groepen; afhankelijk van de natuur.</Bullet>
              <Bullet>Rond 10.000 v.Chr.: <b>landbouwrevolutie</b> in het Midden-Oosten → mensen werden boeren (sedentair).</Bullet>
              <Bullet>Voedseloverschotten → <b>specialisatie</b>, handel en <b>sociale gelaagdheid</b>.</Bullet>
              <Bullet>Ontstaan van <b>dorpen en steden</b>; uitvinding van het <b>schrift</b> (einde prehistorie ca. 3000 v.Chr.).</Bullet>
            </ul>
          </div>
          <div className="bg-white rounded-2xl p-5 shadow-sm">
            <h3 className="font-semibold mb-2">Waar letten docenten op?</h3>
            <ul className="text-sm leading-6">
              <Bullet>Kun je <b>oorzaak → gevolg</b> uitleggen: landbouw → overschot → steden → schrift?</Bullet>
              <Bullet>Kun je begrippen koppelen aan voorbeelden (Egypte/Nijl, Çatalhöyük, Lascaux)?</Bullet>
              <Bullet>Ken je het verschil <b>nomadisch</b> vs <b>sedentair</b>?</Bullet>
            </ul>
          </div>
        </div>
        <Flashcards items={flashcardsT1} />
      </div>
    </Section>
  );
}

function VakT2() {
  return (
    <Section title="Tijdvak 2 – Grieken en Romeinen" icon={<Landmark className="w-6 h-6"/>} subtitle="Politiek, cultuur, religie + flashcards">
      <div className="grid lg:grid-cols-2 gap-6">
        <div className="space-y-4">
          <div className="bg-white rounded-2xl p-5 shadow-sm">
            <h3 className="font-semibold mb-2">Kern</h3>
            <ul className="text-sm leading-6">
              <Bullet><b>Grieken</b>: polis, <b>democratie</b> (Athene), filosofie en wetenschappelijk denken (Socrates, Plato, Aristoteles).</Bullet>
              <Bullet><b>Romeinen</b>: groei van het <b>imperium</b>, <b>romanisering</b>, <b>Pax Romana</b>, recht en infrastructuur (wegen, aquaducten).</Bullet>
              <Bullet><b>Kunst</b>: Griekse zuilen (Dorisch, Ionisch, Korinthisch); Romeinen realistisch en technisch (bogen/koepels).</Bullet>
              <Bullet><b>Religie</b>: van <b>polytheïsme</b> naar <b>monotheïsme</b> (jodendom & christendom). Christendom verbreidt via Rijk; eerst vervolgd.</Bullet>
            </ul>
          </div>
          <div className="bg-white rounded-2xl p-5 shadow-sm">
            <h3 className="font-semibold mb-2">Veelgevraagde examenzinnen</h3>
            <ul className="text-sm leading-6">
              <Bullet>"Democratie in Athene: burger = vrije man met Atheense ouders; recht én plicht tot deelname."</Bullet>
              <Bullet>"Romanisering = overname Romeinse taal/cultuur/recht door veroverde volkeren."</Bullet>
              <Bullet>"Pax Romana → veiligheid + wegen → handel en snelle verspreiding (o.a. christendom)."</Bullet>
            </ul>
          </div>
        </div>
        <Flashcards items={flashcardsT2} />
      </div>
    </Section>
  );
}

function Tijdlijn() {
  return (
    <Section title="Tijdvakken-overzicht" icon={<Layers className="w-6 h-6"/>} subtitle="Lees de kern hardop (0–2 min).">
      <div className="grid md:grid-cols-2 gap-4">
        {tijdvakken.map((t) => (
          <div key={t.nr} className="bg-white rounded-2xl p-4 shadow-sm">
            <div className="flex items-center justify-between">
              <div className="font-semibold">{t.nr}. {t.naam}</div>
              <Pill>{t.jaren}</Pill>
            </div>
            <p className="text-sm opacity-80 mt-1">{t.kern}</p>
          </div>
        ))}
      </div>
    </Section>
  );
}

function Quiz() {
  type QA = { t: string; type: 'open' | 'mc'; check?: (x: string)=>boolean; options?: string[]; answer?: number };
  const bank: QA[] = useMemo(() => [...quiz.t1, ...quiz.t2, ...quiz.tijdlijn], []);
  const [i, setI] = useState(0);
  const [value, setValue] = useState("");
  const [choice, setChoice] = useState<number | null>(null);
  const [correct, setCorrect] = useState<boolean | null>(null);
  const [score, setScore] = useState(0);

  const q = bank[i];

  function submit() {
    if (q.type === 'open') {
      const ok = q.check ? q.check(value) : false;
      setCorrect(ok);
      if (ok) setScore((s) => s + 1);
    } else {
      const ok = choice === q.answer;
      setCorrect(ok);
      if (ok) setScore((s) => s + 1);
    }
  }

  function next() {
    setI((x) => Math.min(x + 1, bank.length - 1));
    setCorrect(null);
    setValue("");
    setChoice(null);
  }

  const progress = ((i) / bank.length) * 100;

  return (
    <Section title="Quiz – actief herinneren" icon={<HelpCircle className="w-6 h-6"/>} subtitle="Korte uitleg verschijnt na je antwoord.">
      <div className="bg-white rounded-2xl p-6 shadow-sm">
        <div className="flex items-center justify-between mb-3">
          <div className="font-semibold">Vraag {i + 1} / {bank.length}</div>
          <div className="flex items-center gap-3">
            <Pill>Score: {score}</Pill>
            <div className="w-40"><Progress value={progress} /></div>
          </div>
        </div>
        <p className="text-lg font-semibold mb-3">{q.t}</p>
        {q.type === 'open' ? (
          <Input value={value} onChange={(e)=>setValue(e.target.value)} placeholder="Typ je antwoord in 1 zin"/>
        ) : (
          <div className="grid md:grid-cols-2 gap-2">
            {q.options!.map((opt, idx) => (
              <Button key={idx} variant={choice===idx?'default':'secondary'} onClick={()=>setChoice(idx)}>{String.fromCharCode(65+idx)}. {opt}</Button>
            ))}
          </div>
        )}
        <div className="flex gap-2 mt-4">
          <Button onClick={submit}>Check</Button>
          <Button variant="secondary" onClick={next}>Volgende</Button>
        </div>
        {correct!==null && (
          <div className={`mt-4 p-4 rounded-xl border ${correct? 'bg-green-50':'bg-red-50'}`}>
            <div className="flex items-center gap-2 font-semibold mb-1">
              {correct? <CheckCircle2 className="w-5 h-5"/> : <XCircle className="w-5 h-5"/>}
              {correct? 'Goed!' : 'Bijna…'}
            </div>
            <p className="text-sm opacity-80">{explain(q)}</p>
          </div>
        )}
      </div>
      <div className="text-xs opacity-70 mt-4 text-center">
        Tip: maak een screenshot van je foute vragen en herhaal die als flashcards.
      </div>
    </Section>
  );
}

function explain(q: any) {
  // Korte uitleg per vraag (samengevat uit het studieplan)
  const map: Record<string, string> = {
    "Wat was de landbouwrevolutie?": "Overgang van jagen/verzamelen naar landbouw en veeteelt; leidde tot vaste woonplaatsen en overschotten.",
    "Wat betekent 'sedentair'?": "Op één plek wonen; tegenovergesteld aan nomadisch.",
    "Wat markeert het einde van de prehistorie?": "De uitvinding van het schrift rond 3000 v.Chr.",
    "Noem één gevolg van landbouw.": "Overschotten → specialisatie, handel, bevolkingsgroei, dorpen/steden, schrift.",
    "Wie zijn bekende Griekse filosofen?": "Socrates, Plato, Aristoteles – grondleggers van logisch en rationeel denken.",
    "Wat betekent romanisering?": "Veroverde volkeren nemen Romeinse taal, cultuur en recht over.",
    "Wat was de Pax Romana?": "Periode van langdurige vrede en welvaart; bevorderde handel en verspreiding (bv. christendom).",
    "Waarom zagen Romeinen het christendom eerst als bedreiging?": "Christenen vereerden slechts één God en weigerden de keizer als goddelijke autoriteit te vereren.",
    "In welk tijdvak hoort 'democratie in Athene' thuis?": "Tijdvak 2: Grieken en Romeinen.",
    "Wanneer eindigt de prehistorie?": "Rond 3000 v.Chr., met het ontstaan van het schrift.",
  };
  return map[q.t] || "Goed onthouden: sluit je antwoord aan op oorzaak → gevolg en gebruik kernbegrippen.";
}
